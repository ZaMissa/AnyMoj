(self.webpackChunktemp_app=self.webpackChunktemp_app||[]).push([[249],{477:()=>{},3133:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>u});var n=s(2555),a=s(5043),i=s(8431),r=s(1520),c=s(4848),o=s(6111),l=s.n(o);const d=new class{async exportData(e){const t={version:"1.0.0",exportDate:new Date,machines:[],settings:{},history:[]};if(e.includeMachines){const{indexedDBService:n}=await Promise.resolve().then(s.bind(s,8431));if(e.selectedMachineIds&&e.selectedMachineIds.length>0)for(const s of e.selectedMachineIds){const e=await n.getMachine(s);e&&t.machines.push(e)}else t.machines=await n.getAllMachines()}if(e.includeSettings){const{indexedDBService:e}=await Promise.resolve().then(s.bind(s,8431));t.settings=await e.getSettings()}if(e.includeHistory){const{indexedDBService:e}=await Promise.resolve().then(s.bind(s,8431));t.history=await e.getConnectionHistory()}let n=JSON.stringify(t,null,2);if(e.encrypt&&e.password){const s={encrypted:!0,data:l().AES.encrypt(n,e.password).toString(),version:t.version,exportDate:t.exportDate};n=JSON.stringify(s,null,2),console.log("Encrypted export structure:",s)}const a=(e.encrypt,"application/json");return new Blob([n],{type:a})}async importData(e,t){const s={success:!1,importedMachines:0,importedSettings:!1,importedHistory:0,errors:[],warnings:[]};try{const i=await this.readFileAsText(e);let r;try{const e=JSON.parse(i);if(e.encrypted){if(!t)return s.errors.push("File is encrypted but no password provided"),s;try{const a=l().AES.decrypt(e.data,t).toString(l().enc.Utf8);if(!a)return s.errors.push("Invalid password or corrupted encrypted data"),s;try{r=JSON.parse(a),console.log("Decrypted backup data structure:",r)}catch(n){return s.errors.push("Failed to parse decrypted data. File may be corrupted."),console.error("JSON parse error:",n),console.error("Decrypted string:",a),s}}catch(a){return s.errors.push("Failed to decrypt data. Check password."),console.error("Decryption error:",a),s}}else r=e;if(!this.validateBackupData(r))return s.errors.push("Invalid backup file format. Expected: version, exportDate, machines, settings, history"),console.error("Validation failed for data:",r),s;await this.importBackupData(r,s),s.success=!0}catch(n){return s.errors.push("Invalid JSON format in backup file"),s}}catch(i){return s.errors.push("Failed to read file: ".concat(i)),s}return s}generateFilename(e){const t=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19),s=e.selectedMachineIds?"selected":"all",n=e.encrypt?"encrypted":"plain";return"machine-backup-".concat(s,"-").concat(n,"-").concat(t,".json")}downloadBlob(e,t){const s=URL.createObjectURL(e),n=document.createElement("a");n.href=s,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}readFileAsText(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=e=>{var s;return t(null===(s=e.target)||void 0===s?void 0:s.result)},n.onerror=e=>s(e),n.readAsText(e)})}validateBackupData(e){try{return e&&"object"===typeof e?"string"!==typeof e.version?(console.error("Validation failed: version is not a string",e.version),!1):e.exportDate?Array.isArray(e.machines)?Array.isArray(e.history)?!(!e.settings||"object"!==typeof e.settings)||(console.error("Validation failed: settings is not an object",e.settings),!1):(console.error("Validation failed: history is not an array",e.history),!1):(console.error("Validation failed: machines is not an array",e.machines),!1):(console.error("Validation failed: exportDate is missing"),!1):(console.error("Validation failed: data is not an object"),!1)}catch(t){return console.error("Validation error:",t),!1}}async importBackupData(e,t){const{indexedDBService:n}=await Promise.resolve().then(s.bind(s,8431));try{for(const s of e.machines)try{await n.getMachine(s.id)?(await n.updateMachine(s),t.warnings.push("Updated existing machine: ".concat(s.name))):(await n.addMachine(s),t.importedMachines++)}catch(a){t.errors.push("Failed to import machine ".concat(s.name,": ").concat(a))}for(const s of e.history)try{await n.addConnectionHistory(s),t.importedHistory++}catch(i){t.warnings.push("Failed to import history entry: ".concat(i))}try{const s=await n.getSettings(),a=this.mergeSettings(s,e.settings);await n.updateSettings(a),t.importedSettings=!0}catch(r){t.warnings.push("Failed to import settings: ".concat(r))}}catch(c){t.errors.push("Import failed: ".concat(c))}}mergeSettings(e,t){return(0,n.A)((0,n.A)((0,n.A)({},e),t),{},{id:e.id,darkMode:void 0!==t.darkMode?t.darkMode:e.darkMode,autoBackup:void 0!==t.autoBackup?t.autoBackup:e.autoBackup,defaultEncryption:void 0!==t.defaultEncryption?t.defaultEncryption:e.defaultEncryption,categories:Array.from(new Set([...e.categories,...t.categories])),customFieldDefinitions:this.mergeCustomFieldDefinitions(e.customFieldDefinitions,t.customFieldDefinitions)})}mergeCustomFieldDefinitions(e,t){const s=[...e];for(const n of t){const e=s.findIndex(e=>e.id===n.id);e>=0?s[e]=n:s.push(n)}return s}async detectEncryption(e){try{const t=await this.readFileAsText(e);return!0===JSON.parse(t).encrypted}catch(t){return!1}}async getExportSummary(e){const{indexedDBService:t}=await Promise.resolve().then(s.bind(s,8431));let n=0;if(e.includeMachines)if(e.selectedMachineIds&&e.selectedMachineIds.length>0)n=e.selectedMachineIds.length;else{n=(await t.getAllMachines()).length}const a=e.includeSettings;let i=!1;if(e.includeHistory){i=(await t.getConnectionHistory()).length>0}const r=500*n+(a?1e3:0)+(i?200:0);return{machineCount:n,hasSettings:a,hasHistory:i,estimatedSize:this.formatFileSize(r)}}formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}async testExportImportCycle(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"test123";try{console.log("Testing export/import cycle...");const t=await this.exportData({includeMachines:!0,includeSettings:!0,includeHistory:!0,selectedMachineIds:[],encrypt:!0,password:e}),s=new File([t],"test-backup.json",{type:"application/json"}),n=await this.importData(s,e);return console.log("Test result:",n),n.success}catch(t){return console.error("Test failed:",t),!1}}};var p=s(579);const h=e=>{let{onSubmit:t,onCancel:s}=e;const[n,i]=(0,a.useState)("");return(0,p.jsxs)("form",{onSubmit:e=>{e.preventDefault(),n.trim()&&t(n.trim())},className:"password-form",children:[(0,p.jsx)("input",{type:"password",value:n,onChange:e=>i(e.target.value),placeholder:"Enter password",className:"form-input",autoFocus:!0}),(0,p.jsxs)("div",{className:"form-actions",children:[(0,p.jsx)("button",{type:"button",onClick:s,className:"btn btn-secondary",children:"Cancel"}),(0,p.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:!n.trim(),children:"Import"})]})]})},m=e=>{let{machines:t,onImportComplete:s}=e;const[i,r]=(0,a.useState)(!1),[o,l]=(0,a.useState)(!1),[m,u]=(0,a.useState)({includeMachines:!0,includeSettings:!0,includeHistory:!0,selectedMachineIds:[],encrypt:!1,password:""}),[g,y]=(0,a.useState)(null),[x,b]=(0,a.useState)(!1),[f,j]=(0,a.useState)(null),v=(0,a.useRef)(null),k=async(e,t)=>{try{l(!0),y(null);const n=await d.importData(e,t);y(n),n.success?(alert("\u2705 Import completed!\n\nImported: ".concat(n.importedMachines," machines, ").concat(n.importedHistory," history entries").concat(n.importedSettings?", settings":"")),s&&s(n)):alert("\u274c Import failed:\n".concat(n.errors.join("\n")))}catch(n){console.error("Import failed:",n),alert("\u274c Import failed: ".concat(n))}finally{l(!1)}};return(0,p.jsxs)("div",{className:"export-import",children:[(0,p.jsx)("h3",{children:"Export & Import Data"}),(0,p.jsxs)("div",{className:"export-section",children:[(0,p.jsx)("h4",{children:"Export Data"}),(0,p.jsxs)("div",{className:"export-options",children:[(0,p.jsxs)("div",{className:"option-group",children:[(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:m.includeMachines,onChange:e=>u(t=>(0,n.A)((0,n.A)({},t),{},{includeMachines:e.target.checked}))}),"Include Machines"]}),m.includeMachines&&(0,p.jsxs)("div",{className:"machine-selection",children:[(0,p.jsxs)("div",{className:"selection-controls",children:[(0,p.jsx)("button",{type:"button",onClick:()=>{u(e=>(0,n.A)((0,n.A)({},e),{},{selectedMachineIds:t.map(e=>e.id)}))},className:"btn btn-sm",children:"Select All"}),(0,p.jsx)("button",{type:"button",onClick:()=>{u(e=>(0,n.A)((0,n.A)({},e),{},{selectedMachineIds:[]}))},className:"btn btn-sm",children:"Clear All"})]}),(0,p.jsx)("div",{className:"machine-list",children:t.map(e=>(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:m.selectedMachineIds.includes(e.id),onChange:()=>{return t=e.id,void u(e=>(0,n.A)((0,n.A)({},e),{},{selectedMachineIds:e.selectedMachineIds.includes(t)?e.selectedMachineIds.filter(e=>e!==t):[...e.selectedMachineIds,t]}));var t}}),e.name," (",e.anydeskId,")"]},e.id))})]})]}),(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:m.includeSettings,onChange:e=>u(t=>(0,n.A)((0,n.A)({},t),{},{includeSettings:e.target.checked}))}),"Include Settings"]}),(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:m.includeHistory,onChange:e=>u(t=>(0,n.A)((0,n.A)({},t),{},{includeHistory:e.target.checked}))}),"Include Connection History"]})]}),(0,p.jsxs)("div",{className:"encryption-section",children:[(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:m.encrypt,onChange:e=>u(t=>(0,n.A)((0,n.A)({},t),{},{encrypt:e.target.checked}))}),"Encrypt Export"]}),m.encrypt&&(0,p.jsx)("div",{className:"password-input",children:(0,p.jsx)("input",{type:"password",placeholder:"Enter encryption password",value:m.password,onChange:e=>u(t=>(0,n.A)((0,n.A)({},t),{},{password:e.target.value})),className:"form-input"})})]}),(0,p.jsx)("button",{onClick:async()=>{if(!m.encrypt||m.password.trim())try{r(!0);const e=await d.exportData(m),t=d.generateFilename(m);d.downloadBlob(e,t),alert("\u2705 Export completed! File: ".concat(t))}catch(e){console.error("Export failed:",e),alert("\u274c Export failed: ".concat(e))}finally{r(!1)}else alert("Please enter a password for encryption")},disabled:i,className:"btn btn-primary",children:i?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(c.A,{size:"sm"}),"Exporting..."]}):"Export Data"})]}),(0,p.jsxs)("div",{className:"import-section",children:[(0,p.jsx)("h4",{children:"Import Data"}),(0,p.jsx)("div",{className:"import-info",children:(0,p.jsx)("p",{children:"Import data from a previously exported backup file. The import will merge with existing data."})}),(0,p.jsxs)("div",{className:"file-input-container",children:[(0,p.jsx)("input",{ref:v,type:"file",accept:".json",onChange:async e=>{var t;const s=null===(t=e.target.files)||void 0===t?void 0:t[0];if(s){v.current&&(v.current.value="");try{await d.detectEncryption(s)?(j(s),b(!0)):await k(s)}catch(n){console.error("File processing error:",n),alert("\u274c Failed to process file: ".concat(n))}}},className:"file-input",id:"import-file"}),(0,p.jsx)("label",{htmlFor:"import-file",className:"file-input-label",children:o?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(c.A,{size:"sm"}),"Importing..."]}):"Choose Backup File"})]}),g&&(0,p.jsxs)("div",{className:"import-result ".concat(g.success?"success":"error"),children:[(0,p.jsx)("h5",{children:"Import Result"}),(0,p.jsxs)("p",{children:["\u2705 Imported: ",g.importedMachines," machines, ",g.importedHistory," history entries"]}),g.importedSettings&&(0,p.jsx)("p",{children:"\u2705 Settings imported"}),g.errors.length>0&&(0,p.jsxs)("div",{className:"errors",children:[(0,p.jsx)("h6",{children:"Errors:"}),(0,p.jsx)("ul",{children:g.errors.map((e,t)=>(0,p.jsx)("li",{children:e},t))})]}),g.warnings.length>0&&(0,p.jsxs)("div",{className:"warnings",children:[(0,p.jsx)("h6",{children:"Warnings:"}),(0,p.jsx)("ul",{children:g.warnings.map((e,t)=>(0,p.jsx)("li",{children:e},t))})]})]})]}),x&&(0,p.jsx)("div",{className:"password-modal-overlay",children:(0,p.jsxs)("div",{className:"password-modal",children:[(0,p.jsx)("h4",{children:"Encrypted File"}),(0,p.jsx)("p",{children:"This backup file is encrypted. Please enter the password:"}),(0,p.jsx)(h,{onSubmit:async e=>{f&&(b(!1),await k(f,e),j(null))},onCancel:()=>{b(!1),j(null)}})]})})]})},u=()=>{const[e,t]=(0,a.useState)(null),[s,o]=(0,a.useState)([]),[l,d]=(0,a.useState)(!0),[h,u]=(0,a.useState)(!1);(0,a.useEffect)(()=>{g(),y()},[]);const g=async()=>{try{d(!0);const e=await i.indexedDBService.getSettings();t(e),null!==e&&void 0!==e&&e.darkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}catch(e){console.error("Failed to load settings:",e)}finally{d(!1)}},y=async()=>{try{const e=await i.indexedDBService.getAllMachines();o(e)}catch(e){console.error("Failed to load machines:",e)}},x=(s,a)=>{if(e){const i=(0,n.A)((0,n.A)({},e),{},{[s]:a});t(i),"darkMode"===s&&(a?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"))}},b=()=>new Promise(e=>{const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.5);\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 10000;\n      ";const s=document.createElement("div");s.style.cssText="\n        background: white;\n        padding: 24px;\n        border-radius: 8px;\n        max-width: 400px;\n        width: 90%;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      ",s.innerHTML='\n        <h3 style="margin: 0 0 16px 0; color: #d32f2f; font-size: 18px;">\u26a0\ufe0f Clear All Data</h3>\n        <p style="margin: 0 0 16px 0; color: #333; line-height: 1.5;">\n          This will permanently delete ALL your machines, connection history, and settings. \n          <strong>This action cannot be undone!</strong>\n        </p>\n        <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">\n          Before proceeding, please ensure you have exported your data as a backup.\n        </p>\n        <label style="display: flex; align-items: center; margin: 16px 0; cursor: pointer;">\n          <input type="checkbox" id="backup-confirmation" style="margin-right: 8px;">\n          <span style="color: #333; font-weight: 500;">\n            I confirm that I have made a backup of my data and understand this action is irreversible\n          </span>\n        </label>\n        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">\n          <button id="cancel-btn" style="\n            padding: 8px 16px;\n            border: 1px solid #ccc;\n            background: white;\n            border-radius: 4px;\n            cursor: pointer;\n            color: #333;\n          ">Cancel</button>\n          <button id="confirm-btn" style="\n            padding: 8px 16px;\n            border: none;\n            background: #d32f2f;\n            color: white;\n            border-radius: 4px;\n            cursor: pointer;\n            opacity: 0.5;\n          " disabled>Clear All Data</button>\n        </div>\n      ',t.appendChild(s),document.body.appendChild(t);const n=s.querySelector("#backup-confirmation"),a=s.querySelector("#cancel-btn"),i=s.querySelector("#confirm-btn");n.addEventListener("change",()=>{n.checked?(i.disabled=!1,i.style.opacity="1"):(i.disabled=!0,i.style.opacity="0.5")}),a.addEventListener("click",()=>{document.body.removeChild(t),e(!1)}),i.addEventListener("click",()=>{n.checked&&(document.body.removeChild(t),e(!0))}),t.addEventListener("click",s=>{s.target===t&&(document.body.removeChild(t),e(!1))});const r=s=>{"Escape"===s.key&&(document.body.removeChild(t),document.removeEventListener("keydown",r),e(!1))};document.addEventListener("keydown",r)});return l?(0,p.jsxs)("div",{className:"page-loading",children:[(0,p.jsx)(c.A,{size:"lg"}),(0,p.jsx)("p",{children:"Loading settings..."})]}):e?(0,p.jsxs)("div",{className:"settings-page",children:[(0,p.jsxs)("div",{className:"page-header",children:[(0,p.jsx)("h1",{className:"page-title",children:"Settings"}),(0,p.jsx)("p",{className:"page-subtitle",children:"Manage your app preferences and data"})]}),(0,p.jsxs)("div",{className:"settings-sections",children:[(0,p.jsxs)("div",{className:"settings-section",children:[(0,p.jsx)("h3",{children:"Appearance"}),(0,p.jsxs)("div",{className:"setting-item",children:[(0,p.jsxs)("div",{className:"setting-info",children:[(0,p.jsx)("label",{className:"setting-label",children:"Dark Mode"}),(0,p.jsx)("p",{className:"setting-description",children:"Enable dark theme for better viewing in low light"})]}),(0,p.jsxs)("label",{className:"toggle-switch",children:[(0,p.jsx)("input",{type:"checkbox",checked:e.darkMode,onChange:e=>x("darkMode",e.target.checked),"aria-label":"Toggle dark mode"}),(0,p.jsx)("span",{className:"toggle-slider"})]})]})]}),(0,p.jsxs)("div",{className:"settings-section",children:[(0,p.jsx)("h3",{children:"Backup & Restore"}),(0,p.jsxs)("div",{className:"setting-item",children:[(0,p.jsxs)("div",{className:"setting-info",children:[(0,p.jsx)("label",{className:"setting-label",children:"Auto Backup"}),(0,p.jsx)("p",{className:"setting-description",children:"Automatically backup data to browser storage"})]}),(0,p.jsxs)("label",{className:"toggle-switch",children:[(0,p.jsx)("input",{type:"checkbox",checked:e.autoBackup,onChange:e=>x("autoBackup",e.target.checked),"aria-label":"Toggle auto backup"}),(0,p.jsx)("span",{className:"toggle-slider"})]})]}),(0,p.jsxs)("div",{className:"setting-item",children:[(0,p.jsxs)("div",{className:"setting-info",children:[(0,p.jsx)("label",{className:"setting-label",children:"Default Encryption"}),(0,p.jsx)("p",{className:"setting-description",children:"Encrypt exports by default (you can still choose per export)"})]}),(0,p.jsxs)("label",{className:"toggle-switch",children:[(0,p.jsx)("input",{type:"checkbox",checked:e.defaultEncryption,onChange:e=>x("defaultEncryption",e.target.checked),"aria-label":"Toggle default encryption"}),(0,p.jsx)("span",{className:"toggle-slider"})]})]})]}),(0,p.jsxs)("div",{className:"settings-section",children:[(0,p.jsx)("h3",{children:"Data Management"}),(0,p.jsx)("div",{className:"setting-actions",children:(0,p.jsx)("button",{onClick:async()=>{if(await b())try{await r.q.clearBackup(),await i.indexedDBService.clearAllData(),localStorage.setItem("skipAutoRestore","true"),alert("All data has been cleared. The app will reload."),window.location.reload()}catch(e){console.error("Failed to clear data:",e),alert("Failed to clear data. Please try again.")}},className:"btn btn-error",children:"Clear All Data"})}),(0,p.jsx)("div",{className:"setting-info",children:(0,p.jsx)("p",{children:"Use the Export & Import section below for advanced backup and restore functionality with encryption options."})})]}),(0,p.jsx)(m,{machines:s,onImportComplete:async e=>{await g(),await y()}}),(0,p.jsx)("div",{className:"settings-actions",children:(0,p.jsx)("button",{onClick:async()=>{if(e)try{u(!0),await i.indexedDBService.updateSettings(e),e.darkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}catch(t){console.error("Failed to save settings:",t),alert("Failed to save settings. Please try again.")}finally{u(!1)}},disabled:h,className:"btn btn-primary btn-lg",children:h?(0,p.jsx)(c.A,{size:"sm"}):"Save Settings"})})]})]}):(0,p.jsxs)("div",{className:"page-error",children:[(0,p.jsx)("h2",{children:"Failed to load settings"}),(0,p.jsx)("button",{onClick:g,className:"btn btn-primary",children:"Retry"})]})}}}]);
//# sourceMappingURL=249.a8a6761a.chunk.js.map