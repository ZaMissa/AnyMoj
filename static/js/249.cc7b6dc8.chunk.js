(self.webpackChunktemp_app=self.webpackChunktemp_app||[]).push([[249],{477:()=>{},3133:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>m});var a=s(2555),n=s(5043),i=s(8431),r=s(1520),c=s(4848),o=s(6111),l=s.n(o);const d=new class{async exportData(e){const t={version:"1.0.0",exportDate:new Date,machines:[],settings:{},history:[]};if(e.includeMachines){const{indexedDBService:a}=await Promise.resolve().then(s.bind(s,8431));if(e.selectedMachineIds&&e.selectedMachineIds.length>0)for(const s of e.selectedMachineIds){const e=await a.getMachine(s);e&&t.machines.push(e)}else t.machines=await a.getAllMachines()}if(e.includeSettings){const{indexedDBService:e}=await Promise.resolve().then(s.bind(s,8431));t.settings=await e.getSettings()}if(e.includeHistory){const{indexedDBService:e}=await Promise.resolve().then(s.bind(s,8431));t.history=await e.getConnectionHistory()}let a=JSON.stringify(t,null,2);if(e.encrypt&&e.password){const s={encrypted:!0,data:l().AES.encrypt(a,e.password).toString(),version:t.version,exportDate:t.exportDate};a=JSON.stringify(s,null,2),console.log("Encrypted export structure:",s)}const n=(e.encrypt,"application/json");return new Blob([a],{type:n})}async importData(e,t){const s={success:!1,importedMachines:0,importedSettings:!1,importedHistory:0,errors:[],warnings:[]};try{const i=await this.readFileAsText(e);let r;try{const e=JSON.parse(i);if(e.encrypted){if(!t)return s.errors.push("File is encrypted but no password provided"),s;try{const n=l().AES.decrypt(e.data,t).toString(l().enc.Utf8);if(!n)return s.errors.push("Invalid password or corrupted encrypted data"),s;try{r=JSON.parse(n),console.log("Decrypted backup data structure:",r)}catch(a){return s.errors.push("Failed to parse decrypted data. File may be corrupted."),console.error("JSON parse error:",a),console.error("Decrypted string:",n),s}}catch(n){return s.errors.push("Failed to decrypt data. Check password."),console.error("Decryption error:",n),s}}else r=e;if(!this.validateBackupData(r))return s.errors.push("Invalid backup file format. Expected: version, exportDate, machines, settings, history"),console.error("Validation failed for data:",r),s;await this.importBackupData(r,s),s.success=!0}catch(a){return s.errors.push("Invalid JSON format in backup file"),s}}catch(i){return s.errors.push("Failed to read file: ".concat(i)),s}return s}generateFilename(e){const t=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19),s=e.selectedMachineIds?"selected":"all",a=e.encrypt?"encrypted":"plain";return"machine-backup-".concat(s,"-").concat(a,"-").concat(t,".json")}downloadBlob(e,t){const s=URL.createObjectURL(e),a=document.createElement("a");a.href=s,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}readFileAsText(e){return new Promise((t,s)=>{const a=new FileReader;a.onload=e=>{var s;return t(null===(s=e.target)||void 0===s?void 0:s.result)},a.onerror=e=>s(e),a.readAsText(e)})}validateBackupData(e){try{return e&&"object"===typeof e?"string"!==typeof e.version?(console.error("Validation failed: version is not a string",e.version),!1):e.exportDate?Array.isArray(e.machines)?Array.isArray(e.history)?!(!e.settings||"object"!==typeof e.settings)||(console.error("Validation failed: settings is not an object",e.settings),!1):(console.error("Validation failed: history is not an array",e.history),!1):(console.error("Validation failed: machines is not an array",e.machines),!1):(console.error("Validation failed: exportDate is missing"),!1):(console.error("Validation failed: data is not an object"),!1)}catch(t){return console.error("Validation error:",t),!1}}async importBackupData(e,t){const{indexedDBService:a}=await Promise.resolve().then(s.bind(s,8431));try{for(const s of e.machines)try{await a.getMachine(s.id)?(await a.updateMachine(s),t.warnings.push("Updated existing machine: ".concat(s.name))):(await a.addMachine(s),t.importedMachines++)}catch(n){t.errors.push("Failed to import machine ".concat(s.name,": ").concat(n))}for(const s of e.history)try{await a.addConnectionHistory(s),t.importedHistory++}catch(i){t.warnings.push("Failed to import history entry: ".concat(i))}try{const s=await a.getSettings(),n=this.mergeSettings(s,e.settings);await a.updateSettings(n),t.importedSettings=!0}catch(r){t.warnings.push("Failed to import settings: ".concat(r))}}catch(c){t.errors.push("Import failed: ".concat(c))}}mergeSettings(e,t){return(0,a.A)((0,a.A)((0,a.A)({},e),t),{},{id:e.id,darkMode:void 0!==t.darkMode?t.darkMode:e.darkMode,autoBackup:void 0!==t.autoBackup?t.autoBackup:e.autoBackup,defaultEncryption:void 0!==t.defaultEncryption?t.defaultEncryption:e.defaultEncryption,categories:Array.from(new Set([...e.categories,...t.categories])),customFieldDefinitions:this.mergeCustomFieldDefinitions(e.customFieldDefinitions,t.customFieldDefinitions)})}mergeCustomFieldDefinitions(e,t){const s=[...e];for(const a of t){const e=s.findIndex(e=>e.id===a.id);e>=0?s[e]=a:s.push(a)}return s}async detectEncryption(e){try{const t=await this.readFileAsText(e);return!0===JSON.parse(t).encrypted}catch(t){return!1}}async getExportSummary(e){const{indexedDBService:t}=await Promise.resolve().then(s.bind(s,8431));let a=0;if(e.includeMachines)if(e.selectedMachineIds&&e.selectedMachineIds.length>0)a=e.selectedMachineIds.length;else{a=(await t.getAllMachines()).length}const n=e.includeSettings;let i=!1;if(e.includeHistory){i=(await t.getConnectionHistory()).length>0}const r=500*a+(n?1e3:0)+(i?200:0);return{machineCount:a,hasSettings:n,hasHistory:i,estimatedSize:this.formatFileSize(r)}}formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}async testExportImportCycle(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"test123";try{console.log("Testing export/import cycle...");const t=await this.exportData({includeMachines:!0,includeSettings:!0,includeHistory:!0,selectedMachineIds:[],encrypt:!0,password:e}),s=new File([t],"test-backup.json",{type:"application/json"}),a=await this.importData(s,e);return console.log("Test result:",a),a.success}catch(t){return console.error("Test failed:",t),!1}}};var p=s(579);const h=e=>{let{onSubmit:t,onCancel:s}=e;const[a,i]=(0,n.useState)("");return(0,p.jsxs)("form",{onSubmit:e=>{e.preventDefault(),a.trim()&&t(a.trim())},className:"password-form",children:[(0,p.jsx)("input",{type:"password",value:a,onChange:e=>i(e.target.value),placeholder:"Enter password",className:"form-input",autoFocus:!0}),(0,p.jsxs)("div",{className:"form-actions",children:[(0,p.jsx)("button",{type:"button",onClick:s,className:"btn btn-secondary",children:"Cancel"}),(0,p.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:!a.trim(),children:"Import"})]})]})},u=e=>{let{machines:t,onImportComplete:s}=e;const[i,r]=(0,n.useState)(!1),[o,l]=(0,n.useState)(!1),[u,m]=(0,n.useState)({includeMachines:!0,includeSettings:!0,includeHistory:!0,selectedMachineIds:[],encrypt:!1,password:""}),[g,x]=(0,n.useState)(null),[y,j]=(0,n.useState)(!1),[f,b]=(0,n.useState)(null),w=(0,n.useRef)(null),v=async(e,t)=>{try{l(!0),x(null);const a=await d.importData(e,t);x(a),a.success?(alert("\u2705 Import completed!\n\nImported: ".concat(a.importedMachines," machines, ").concat(a.importedHistory," history entries").concat(a.importedSettings?", settings":"")),s&&s(a)):alert("\u274c Import failed:\n".concat(a.errors.join("\n")))}catch(a){console.error("Import failed:",a),alert("\u274c Import failed: ".concat(a))}finally{l(!1)}};return(0,p.jsxs)("div",{className:"export-import",children:[(0,p.jsx)("h3",{children:"Export & Import Data"}),(0,p.jsxs)("div",{className:"export-section",children:[(0,p.jsx)("h4",{children:"Export Data"}),(0,p.jsxs)("div",{className:"export-options",children:[(0,p.jsxs)("div",{className:"option-group",children:[(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:u.includeMachines,onChange:e=>m(t=>(0,a.A)((0,a.A)({},t),{},{includeMachines:e.target.checked}))}),"Include Machines"]}),u.includeMachines&&(0,p.jsxs)("div",{className:"machine-selection",children:[(0,p.jsxs)("div",{className:"selection-controls",children:[(0,p.jsx)("button",{type:"button",onClick:()=>{m(e=>(0,a.A)((0,a.A)({},e),{},{selectedMachineIds:t.map(e=>e.id)}))},className:"btn btn-sm",children:"Select All"}),(0,p.jsx)("button",{type:"button",onClick:()=>{m(e=>(0,a.A)((0,a.A)({},e),{},{selectedMachineIds:[]}))},className:"btn btn-sm",children:"Clear All"})]}),(0,p.jsx)("div",{className:"machine-list",children:t.map(e=>(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:u.selectedMachineIds.includes(e.id),onChange:()=>{return t=e.id,void m(e=>(0,a.A)((0,a.A)({},e),{},{selectedMachineIds:e.selectedMachineIds.includes(t)?e.selectedMachineIds.filter(e=>e!==t):[...e.selectedMachineIds,t]}));var t}}),e.name," (",e.anydeskId,")"]},e.id))})]})]}),(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:u.includeSettings,onChange:e=>m(t=>(0,a.A)((0,a.A)({},t),{},{includeSettings:e.target.checked}))}),"Include Settings"]}),(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:u.includeHistory,onChange:e=>m(t=>(0,a.A)((0,a.A)({},t),{},{includeHistory:e.target.checked}))}),"Include Connection History"]})]}),(0,p.jsxs)("div",{className:"encryption-section",children:[(0,p.jsxs)("label",{className:"checkbox-label",children:[(0,p.jsx)("input",{type:"checkbox",checked:u.encrypt,onChange:e=>m(t=>(0,a.A)((0,a.A)({},t),{},{encrypt:e.target.checked}))}),"Encrypt Export"]}),u.encrypt&&(0,p.jsx)("div",{className:"password-input",children:(0,p.jsx)("input",{type:"password",placeholder:"Enter encryption password",value:u.password,onChange:e=>m(t=>(0,a.A)((0,a.A)({},t),{},{password:e.target.value})),className:"form-input"})})]}),(0,p.jsx)("button",{onClick:async()=>{if(!u.encrypt||u.password.trim())try{r(!0);const e=await d.exportData(u),t=d.generateFilename(u);d.downloadBlob(e,t),alert("\u2705 Export completed! File: ".concat(t))}catch(e){console.error("Export failed:",e),alert("\u274c Export failed: ".concat(e))}finally{r(!1)}else alert("Please enter a password for encryption")},disabled:i,className:"btn btn-primary",children:i?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(c.A,{size:"sm"}),"Exporting..."]}):"Export Data"})]}),(0,p.jsxs)("div",{className:"import-section",children:[(0,p.jsx)("h4",{children:"Import Data"}),(0,p.jsx)("div",{className:"import-info",children:(0,p.jsx)("p",{children:"Import data from a previously exported backup file. The import will merge with existing data."})}),(0,p.jsxs)("div",{className:"file-input-container",children:[(0,p.jsx)("input",{ref:w,type:"file",accept:".json",onChange:async e=>{var t;const s=null===(t=e.target.files)||void 0===t?void 0:t[0];if(s){w.current&&(w.current.value="");try{await d.detectEncryption(s)?(b(s),j(!0)):await v(s)}catch(a){console.error("File processing error:",a),alert("\u274c Failed to process file: ".concat(a))}}},className:"file-input",id:"import-file"}),(0,p.jsx)("label",{htmlFor:"import-file",className:"file-input-label",children:o?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(c.A,{size:"sm"}),"Importing..."]}):"Choose Backup File"})]}),g&&(0,p.jsxs)("div",{className:"import-result ".concat(g.success?"success":"error"),children:[(0,p.jsx)("h5",{children:"Import Result"}),(0,p.jsxs)("p",{children:["\u2705 Imported: ",g.importedMachines," machines, ",g.importedHistory," history entries"]}),g.importedSettings&&(0,p.jsx)("p",{children:"\u2705 Settings imported"}),g.errors.length>0&&(0,p.jsxs)("div",{className:"errors",children:[(0,p.jsx)("h6",{children:"Errors:"}),(0,p.jsx)("ul",{children:g.errors.map((e,t)=>(0,p.jsx)("li",{children:e},t))})]}),g.warnings.length>0&&(0,p.jsxs)("div",{className:"warnings",children:[(0,p.jsx)("h6",{children:"Warnings:"}),(0,p.jsx)("ul",{children:g.warnings.map((e,t)=>(0,p.jsx)("li",{children:e},t))})]})]})]}),y&&(0,p.jsx)("div",{className:"password-modal-overlay",children:(0,p.jsxs)("div",{className:"password-modal",children:[(0,p.jsx)("h4",{children:"Encrypted File"}),(0,p.jsx)("p",{children:"This backup file is encrypted. Please enter the password:"}),(0,p.jsx)(h,{onSubmit:async e=>{f&&(j(!1),await v(f,e),b(null))},onCancel:()=>{j(!1),b(null)}})]})})]})},m=()=>{const[e,t]=(0,n.useState)(null),[s,o]=(0,n.useState)([]),[l,d]=(0,n.useState)(!0),[h,m]=(0,n.useState)(!1);(0,n.useEffect)(()=>{g(),x()},[]);const g=async()=>{try{d(!0);const e=await i.indexedDBService.getSettings();t(e)}catch(e){console.error("Failed to load settings:",e)}finally{d(!1)}},x=async()=>{try{const e=await i.indexedDBService.getAllMachines();o(e)}catch(e){console.error("Failed to load machines:",e)}},y=(s,n)=>{e&&t((0,a.A)((0,a.A)({},e),{},{[s]:n}))};return l?(0,p.jsxs)("div",{className:"page-loading",children:[(0,p.jsx)(c.A,{size:"lg"}),(0,p.jsx)("p",{children:"Loading settings..."})]}):e?(0,p.jsxs)("div",{className:"settings-page",children:[(0,p.jsxs)("div",{className:"page-header",children:[(0,p.jsx)("h1",{className:"page-title",children:"Settings"}),(0,p.jsx)("p",{className:"page-subtitle",children:"Manage your app preferences and data"})]}),(0,p.jsxs)("div",{className:"settings-sections",children:[(0,p.jsxs)("div",{className:"settings-section",children:[(0,p.jsx)("h3",{children:"Appearance"}),(0,p.jsxs)("div",{className:"setting-item",children:[(0,p.jsxs)("div",{className:"setting-info",children:[(0,p.jsx)("label",{className:"setting-label",children:"Dark Mode"}),(0,p.jsx)("p",{className:"setting-description",children:"Enable dark theme for better viewing in low light"})]}),(0,p.jsxs)("label",{className:"toggle-switch",children:[(0,p.jsx)("input",{type:"checkbox",checked:e.darkMode,onChange:e=>y("darkMode",e.target.checked),"aria-label":"Toggle dark mode"}),(0,p.jsx)("span",{className:"toggle-slider"})]})]})]}),(0,p.jsxs)("div",{className:"settings-section",children:[(0,p.jsx)("h3",{children:"Backup & Restore"}),(0,p.jsxs)("div",{className:"setting-item",children:[(0,p.jsxs)("div",{className:"setting-info",children:[(0,p.jsx)("label",{className:"setting-label",children:"Auto Backup"}),(0,p.jsx)("p",{className:"setting-description",children:"Automatically backup data to browser storage"})]}),(0,p.jsxs)("label",{className:"toggle-switch",children:[(0,p.jsx)("input",{type:"checkbox",checked:e.autoBackup,onChange:e=>y("autoBackup",e.target.checked),"aria-label":"Toggle auto backup"}),(0,p.jsx)("span",{className:"toggle-slider"})]})]}),(0,p.jsxs)("div",{className:"setting-item",children:[(0,p.jsxs)("div",{className:"setting-info",children:[(0,p.jsx)("label",{className:"setting-label",children:"Default Encryption"}),(0,p.jsx)("p",{className:"setting-description",children:"Encrypt exports by default (you can still choose per export)"})]}),(0,p.jsxs)("label",{className:"toggle-switch",children:[(0,p.jsx)("input",{type:"checkbox",checked:e.defaultEncryption,onChange:e=>y("defaultEncryption",e.target.checked),"aria-label":"Toggle default encryption"}),(0,p.jsx)("span",{className:"toggle-slider"})]})]})]}),(0,p.jsxs)("div",{className:"settings-section",children:[(0,p.jsx)("h3",{children:"Data Management"}),(0,p.jsx)("div",{className:"setting-actions",children:(0,p.jsx)("button",{onClick:async()=>{if(window.confirm("Are you sure you want to clear all data? This action cannot be undone.")&&window.confirm("This will delete ALL machines, history, and settings. Are you absolutely sure?"))try{await r.q.clearBackup(),await i.indexedDBService.clearAllData(),localStorage.setItem("skipAutoRestore","true"),alert("All data has been cleared. The app will reload."),window.location.reload()}catch(e){console.error("Failed to clear data:",e),alert("Failed to clear data. Please try again.")}},className:"btn btn-error",children:"Clear All Data"})}),(0,p.jsx)("div",{className:"setting-info",children:(0,p.jsx)("p",{children:"Use the Export & Import section below for advanced backup and restore functionality with encryption options."})})]}),(0,p.jsx)(u,{machines:s,onImportComplete:async e=>{await g(),await x()}}),(0,p.jsx)("div",{className:"settings-actions",children:(0,p.jsx)("button",{onClick:async()=>{if(e)try{m(!0),await i.indexedDBService.updateSettings(e),e.darkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}catch(t){console.error("Failed to save settings:",t),alert("Failed to save settings. Please try again.")}finally{m(!1)}},disabled:h,className:"btn btn-primary btn-lg",children:h?(0,p.jsx)(c.A,{size:"sm"}):"Save Settings"})})]})]}):(0,p.jsxs)("div",{className:"page-error",children:[(0,p.jsx)("h2",{children:"Failed to load settings"}),(0,p.jsx)("button",{onClick:g,className:"btn btn-primary",children:"Retry"})]})}}}]);
//# sourceMappingURL=249.cc7b6dc8.chunk.js.map